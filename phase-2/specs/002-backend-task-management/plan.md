# Implementation Plan: Backend Task Management Module

**Branch**: `002-backend-task-management` | **Date**: 2025-12-11 | **Spec**: [Feature Spec](./spec.md)
**Input**: Feature specification from `/specs/002-backend-task-management/spec.md`

**Note**: This plan is generated by the `/sp.plan` command and provides architectural design for Phase-2 backend implementation.

## Summary

Implement a complete backend Task Management API using FastAPI and SQLAlchemy for a Neon PostgreSQL database. The backend serves a React frontend with full CRUD operations for tasks, automatic history logging for audit trails, analytics endpoints for dashboard insights, and consistent response formatting with SweetAlert2 popup triggers. System must handle concurrent requests safely, validate all inputs, support MCP server integrations, and provide paginated history queries. Core implementation spans 7 API endpoints with automatic database migrations and referential integrity constraints.

## Technical Context

**Language/Version**: Python 3.11+ (async-compatible runtime)
**Primary Dependencies**: FastAPI (REST API framework), SQLAlchemy 2.0+ (ORM), Alembic (migrations), pydantic (validation), python-dateutil (timezone handling)
**Storage**: Neon PostgreSQL (managed PostgreSQL service)
**Testing**: pytest with pytest-asyncio for async endpoint testing
**Target Platform**: Linux server (cloud deployment via Neon/Docker)
**Project Type**: Backend API (microservice architecture compatible)
**Performance Goals**: <100ms response time for CRUD operations, 100+ concurrent connections, 99.9% uptime
**Constraints**: Connection pool: 5-20 active connections (Neon limits), request timeout: 30s, database transaction timeout: 15s
**Scale/Scope**: Single-user MVP initial scope, horizontally scalable to multi-tenant with minimal changes

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

✅ **MCP Server Usage**: Specification explicitly requires MCP integration for database, validation, and error-handling sub-agents. Plan will leverage MCP servers where appropriate.

✅ **Sub-Agent Usage**: Backend logic delegable to Back-End sub-agents. Plan identifies clear delegation points for database operations, validation, and error handling.

✅ **Code Quality**: Python backend following FastAPI best practices, async/await patterns, type hints, and proper error handling aligned with Phase-2 standards.

✅ **Python Standards**: Using Python 3.11+, FastAPI framework (production-ready), SQLAlchemy ORM (industry standard), proper connection pooling and transaction management.

✅ **Database Design**: Neon PostgreSQL with proper schema design, foreign key constraints, cascading deletes, transaction isolation levels.

✅ **API Design**: RESTful API with consistent response format, proper HTTP status codes, comprehensive error handling, input validation via pydantic.

✅ **No Constitution Violations**: Plan complies with Phase-2 Master Agent architecture, emphasizes MCP server integration, delegates to sub-agents appropriately, maintains code quality standards.

## Project Structure

### Documentation (this feature)

```text
specs/[###-feature]/
├── plan.md              # This file (/sp.plan command output)
├── research.md          # Phase 0 output (/sp.plan command)
├── data-model.md        # Phase 1 output (/sp.plan command)
├── quickstart.md        # Phase 1 output (/sp.plan command)
├── contracts/           # Phase 1 output (/sp.plan command)
└── tasks.md             # Phase 2 output (/sp.tasks command - NOT created by /sp.plan)
```

### Source Code (repository root)

```text
backend/
├── main.py                          # Application entry point
├── config.py                        # Configuration and environment variables
├── requirements.txt                 # Python dependencies
├── alembic/                         # Database migrations
│   ├── env.py
│   ├── script.py.mako
│   └── versions/                    # Migration files (000_initial.py, etc.)
├── src/
│   ├── __init__.py
│   ├── models/                      # SQLAlchemy ORM models
│   │   ├── __init__.py
│   │   ├── task.py                  # Task model
│   │   └── task_history.py          # TaskHistory model
│   ├── schemas/                     # Pydantic request/response schemas
│   │   ├── __init__.py
│   │   ├── task.py                  # TaskCreate, TaskUpdate, TaskResponse
│   │   └── history.py               # HistoryResponse, PaginatedHistory
│   ├── services/                    # Business logic layer
│   │   ├── __init__.py
│   │   ├── task_service.py          # Task CRUD operations
│   │   └── history_service.py       # History logging and retrieval
│   ├── api/                         # API route handlers
│   │   ├── __init__.py
│   │   ├── v1/
│   │   │   ├── __init__.py
│   │   │   ├── tasks.py             # Task CRUD endpoints
│   │   │   ├── history.py           # History endpoints
│   │   │   └── stats.py             # Analytics endpoints
│   │   └── dependencies.py          # FastAPI dependencies (DB session)
│   ├── database/                    # Database configuration
│   │   ├── __init__.py
│   │   ├── base.py                  # SQLAlchemy base class
│   │   └── connection.py            # Connection pool configuration
│   ├── utils/                       # Utility functions
│   │   ├── __init__.py
│   │   ├── response.py              # Standard response formatting
│   │   ├── validators.py            # Input validation
│   │   └── timestamps.py            # Timezone handling
│   └── exceptions/                  # Custom exception classes
│       ├── __init__.py
│       └── handlers.py              # FastAPI exception handlers
└── tests/
    ├── conftest.py                  # pytest fixtures and configuration
    ├── contract/                    # Contract/API tests
    │   ├── test_tasks_create.py     # POST /tasks tests
    │   ├── test_tasks_update.py     # PUT /tasks/{id} tests
    │   ├── test_tasks_delete.py     # DELETE /tasks/{id} tests
    │   ├── test_tasks_complete.py   # PATCH /tasks/{id}/complete tests
    │   ├── test_tasks_list.py       # GET /tasks tests
    │   ├── test_history.py          # GET /history tests
    │   └── test_stats.py            # GET /stats/weekly tests
    ├── integration/                 # Integration tests
    │   ├── test_task_workflow.py    # Multi-endpoint workflows
    │   └── test_concurrent.py       # Concurrent request handling
    └── unit/                        # Unit tests
        ├── test_task_service.py     # TaskService unit tests
        └── test_history_service.py  # HistoryService unit tests
```

**Structure Decision**: Backend API microservice architecture using FastAPI. Separates concerns into models (database entities), schemas (API contracts), services (business logic), and api (HTTP handlers). Database layer isolated for easy connection pool management and migrations via Alembic. Comprehensive test coverage with separate contract, integration, and unit test directories. Follows FastAPI best practices with dependency injection and exception handlers.

## Phase 0: Research & Technical Decisions

**Status**: All technical decisions made based on specification requirements. No NEEDS CLARIFICATION items.

**Key Decisions**:

1. **FastAPI + SQLAlchemy**: Industry-standard async Python stack for REST APIs with built-in validation, automatic OpenAPI documentation, and excellent ORM support.

2. **Neon PostgreSQL**: Managed PostgreSQL service eliminates infrastructure concerns, provides automatic backups, built-in replication, and serverless scaling.

3. **Alembic Migrations**: Version-controlled database migrations ensure reproducible deployments and easy rollback capability.

4. **Async/Await**: FastAPI's native async support enables handling 100+ concurrent requests efficiently without thread overhead.

5. **Response Wrapper Pattern**: Consistent `{success, data, popup, error}` response format across all endpoints ensures frontend can parse responses uniformly.

6. **History Logging**: Background task or synchronous logging after commit ensures audit trail completeness without blocking user requests.

**Output**: All technical questions resolved. Ready for Phase 1 design.

## Phase 1: Design Artifacts

### Data Model Design (data-model.md)

Entities to be documented:
- **Task**: User-created task items (7 fields + constraints)
- **TaskHistory**: Immutable audit log entries (5 fields + foreign keys)

Database design includes:
- UUID primary keys (avoiding sequential ID leaks)
- Cascading deletes (history retained even after task deletion)
- Composite indexes for common queries
- Transaction isolation levels for concurrent safety

### API Contracts (contracts/)

REST API endpoints to be documented:
- `POST /tasks` - Create task
- `GET /tasks` - List all tasks
- `GET /tasks/{id}` - Get single task
- `PUT /tasks/{id}` - Update task
- `DELETE /tasks/{id}` - Delete task
- `PATCH /tasks/{id}/complete` - Mark complete
- `PATCH /tasks/{id}/incomplete` - Mark incomplete
- `GET /history` - Paginated history
- `GET /stats/weekly` - Analytics

### Quick Start (quickstart.md)

Setup instructions covering:
- Python 3.11+ installation
- Virtual environment setup
- Dependency installation via pip
- Neon database connection
- Alembic migration execution
- Running development server on port 8000
- Testing with pytest
- Making first API request example

### Agent Context Update

Update `.claude/agents/backend-agent-context.md` to include:
- FastAPI async patterns
- SQLAlchemy relationship handling
- Alembic migration structure
- Neon connection pooling configuration
- Error handling patterns
- Testing patterns

## Complexity Tracking

No Constitution violations detected. Design aligns with Phase-2 Master Agent principles, emphasizes MCP integration, and follows all established code quality standards.
