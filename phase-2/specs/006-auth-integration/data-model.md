# Data Model: Authentication Integration

**Date**: 2025-12-15
**Feature**: 006-auth-integration
**Phase**: 1 - Design & Contracts

## Overview

This document defines the data entities for authentication integration, including new User and Session entities managed by BetterAuth, and updates to existing Task and History entities to support user-scoped data access.

## Entity Definitions

### User (NEW - Managed by BetterAuth)

**Purpose**: Represents an authenticated application user.

**Attributes**:

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | String (UUID) | PRIMARY KEY, NOT NULL | Unique user identifier generated by BetterAuth |
| email | String (255) | UNIQUE, NOT NULL | User email address (used for login) |
| password_hash | String (255) | NOT NULL | Bcrypt/Argon2 hashed password (managed by BetterAuth) |
| created_at | Timestamp | NOT NULL, DEFAULT NOW() | Account creation timestamp |
| updated_at | Timestamp | NOT NULL, DEFAULT NOW() | Last update timestamp |

**Relationships**:
- One User has many Tasks (one-to-many via tasks.user_id)
- One User has many History entries (one-to-many via history.user_id)
- One User has many Sessions (one-to-many via sessions.user_id)

**Validation Rules**:
- Email must match standard email regex: `^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$`
- Email is case-insensitive (stored lowercase)
- Password must be minimum 8 characters (enforced before hashing)
- Password hash is never exposed via API responses

**State Transitions**:
- Created → Active (on successful signup)
- Active → Active (normal usage)
- (Future) Active → Suspended (admin action - out of scope)
- (Future) Active → Deleted (account deletion - out of scope)

**Security Notes**:
- BetterAuth manages password hashing using bcrypt or argon2
- User passwords are never stored in plaintext
- User table is created and managed by BetterAuth MCP server

---

### Session (NEW - Managed by BetterAuth)

**Purpose**: Represents an active user authentication session.

**Attributes**:

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | String (UUID) | PRIMARY KEY, NOT NULL | Unique session identifier |
| user_id | String (UUID) | FOREIGN KEY (users.id), NOT NULL | Associated user |
| jwt_token | String (512) | NOT NULL | JWT token string (not hashed, stored for revocation) |
| expires_at | Timestamp | NOT NULL | Session expiration timestamp (30 days from creation) |
| created_at | Timestamp | NOT NULL, DEFAULT NOW() | Session creation timestamp |
| last_used_at | Timestamp | NOT NULL, DEFAULT NOW() | Last request timestamp using this session |

**Relationships**:
- Each Session belongs to one User (many-to-one via user_id)

**Validation Rules**:
- JWT token must be valid JWT format (verified by jose library)
- expires_at must be in the future (sessions with past expiry are invalid)
- user_id must reference existing user (foreign key constraint)

**State Transitions**:
- Created → Active (on successful login/signup)
- Active → Active (token refresh, last_used_at updated)
- Active → Expired (when current time > expires_at)
- Active → Revoked (on logout - record deleted)

**Security Notes**:
- JWT token stored in database for revocation capability
- Expired sessions are periodically cleaned up (BetterAuth responsibility)
- Session deletion cascades when user is deleted

---

### Task (MODIFIED - Add User Ownership)

**Purpose**: Todo task item owned by a specific user.

**New Attributes**:

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| user_id | String (UUID) | FOREIGN KEY (users.id), NULLABLE | Task owner (nullable for legacy data) |

**Existing Attributes** (unchanged):

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | String (UUID) | PRIMARY KEY, NOT NULL | Unique task identifier |
| title | String (255) | NOT NULL | Task title |
| description | Text | NULLABLE | Optional task description |
| status | Enum | NOT NULL, DEFAULT 'incomplete' | Task status: 'complete' or 'incomplete' |
| created_at | Timestamp | NOT NULL, DEFAULT NOW() | Creation timestamp |
| updated_at | Timestamp | NOT NULL, DEFAULT NOW() | Last update timestamp |

**New Relationships**:
- Each Task belongs to one User (many-to-one via user_id)

**Authorization Rules** (NEW):
- **Read**: User can only read tasks where user_id matches their authenticated user_id
- **Create**: New tasks automatically assigned user_id from JWT token
- **Update**: User can only update tasks where user_id matches their authenticated user_id
- **Delete**: User can only delete tasks where user_id matches their authenticated user_id
- **Legacy data**: Tasks with user_id = NULL are not accessible via API (orphaned tasks)

**Migration Notes**:
- Existing tasks will have user_id = NULL after migration
- NULL user_id tasks are excluded from all API responses (WHERE user_id IS NOT NULL AND user_id = {auth_user_id})
- New tasks enforce user_id = {auth_user_id} (application-level constraint)

---

### History (MODIFIED - Add User Tracking)

**Purpose**: Audit log of task operations performed by users.

**New Attributes**:

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| user_id | String (UUID) | FOREIGN KEY (users.id), NULLABLE | User who performed the action (nullable for legacy) |

**Existing Attributes** (unchanged):

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | Integer | PRIMARY KEY, AUTO_INCREMENT | Unique history entry identifier |
| task_id | String (UUID) | NULLABLE | Associated task (null for deleted tasks) |
| action | Enum | NOT NULL | Action type: 'created', 'updated', 'completed', 'uncompleted', 'deleted' |
| title | String (255) | NOT NULL | Task title at time of action (snapshot) |
| description | Text | NULLABLE | Task description at time of action (snapshot) |
| status | Enum | NOT NULL | Task status at time of action: 'complete' or 'incomplete' |
| timestamp | Timestamp | NOT NULL, DEFAULT NOW() | Action timestamp |

**New Relationships**:
- Each History entry belongs to one User (many-to-one via user_id)

**Authorization Rules** (NEW):
- **Read**: User can only read history entries where user_id matches their authenticated user_id
- **Create**: New history entries automatically assigned user_id from JWT token
- **Update**: History entries are immutable (no updates allowed)
- **Delete**: History entries are never deleted (audit trail preservation)

**Migration Notes**:
- Existing history entries will have user_id = NULL after migration
- NULL user_id entries are excluded from API responses
- New history entries enforce user_id = {auth_user_id}

---

## Entity Relationship Diagram (ERD)

```
┌─────────────────────┐
│       User          │
├─────────────────────┤
│ id (PK)             │───┐
│ email (UNIQUE)      │   │
│ password_hash       │   │
│ created_at          │   │
│ updated_at          │   │
└─────────────────────┘   │
                          │ 1:N
                          │
        ┌─────────────────┼─────────────────┬─────────────────┐
        │                 │                 │                 │
        ↓                 ↓                 ↓                 ↓
┌─────────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│     Session     │ │    Task     │ │   History   │ │   (Future   │
├─────────────────┤ ├─────────────┤ ├─────────────┤ │   entities) │
│ id (PK)         │ │ id (PK)     │ │ id (PK)     │ └─────────────┘
│ user_id (FK)    │ │ user_id (FK)│ │ user_id (FK)│
│ jwt_token       │ │ title       │ │ task_id     │
│ expires_at      │ │ description │ │ action      │
│ created_at      │ │ status      │ │ title       │
│ last_used_at    │ │ created_at  │ │ description │
└─────────────────┘ │ updated_at  │ │ status      │
                    └─────────────┘ │ timestamp   │
                                    └─────────────┘
```

---

## Database Indexes

**Existing Indexes** (unchanged):
- `tasks.id` (PRIMARY KEY - clustered index)
- `history.id` (PRIMARY KEY - clustered index)

**New Indexes** (required for performance):

| Table | Column(s) | Type | Purpose |
|-------|-----------|------|---------|
| users | email | UNIQUE | Enforce email uniqueness, fast login lookup |
| sessions | user_id | BTREE | Fast session lookup by user |
| sessions | expires_at | BTREE | Fast cleanup of expired sessions |
| tasks | user_id | BTREE | Fast user-scoped task queries (GET /tasks) |
| history | user_id | BTREE | Fast user-scoped history queries (GET /history) |
| history | (user_id, timestamp) | COMPOSITE BTREE | Optimized paginated history queries |

**Index Rationale**:
- user_id indexes on tasks and history tables are critical for performance (every query filters by user_id)
- Without indexes, user-scoped queries would require full table scans
- Composite index (user_id, timestamp) on history optimizes "get recent actions" query pattern

---

## Data Volume Estimates

**Assumptions**:
- 1000 concurrent users
- Average 50 tasks per user
- Average 200 history entries per user (4x tasks due to updates, completions)
- Average session duration 15 days (users login twice per month)

**Storage Estimates**:

| Entity | Row Size (bytes) | Rows per User | Total Rows (1K users) | Total Storage |
|--------|-----------------|---------------|----------------------|---------------|
| User | 400 | 1 | 1,000 | ~400 KB |
| Session | 600 | 2 (avg) | 2,000 | ~1.2 MB |
| Task | 500 | 50 | 50,000 | ~25 MB |
| History | 450 | 200 | 200,000 | ~90 MB |
| **Total** | - | - | **253,000** | **~117 MB** |

**Query Performance Expectations**:
- GET /tasks (50 tasks per user with user_id index): <50ms
- GET /history (paginated 20 entries with composite index): <30ms
- JWT validation (in-memory cache hit rate 95%): <5ms
- JWT validation (cache miss + DB lookup): <40ms

---

## Validation Rules Summary

### User
- Email: Valid format, unique, max 255 chars
- Password: Min 8 chars (pre-hash), hashed with bcrypt/argon2
- No duplicate emails (case-insensitive)

### Session
- JWT token: Valid JWT structure, not expired
- expires_at: Must be future timestamp
- user_id: Must reference existing user

### Task
- user_id: Must match authenticated user (authorization check)
- title: Required, max 255 chars
- description: Optional, text field
- status: Enum ('complete' | 'incomplete')

### History
- user_id: Must match authenticated user (authorization check)
- action: Enum ('created', 'updated', 'completed', 'uncompleted', 'deleted')
- Immutable after creation (no updates)

---

## Migration Strategy

### Step 1: Add Columns (Backward Compatible)
```sql
ALTER TABLE tasks ADD COLUMN user_id VARCHAR(36) NULL;
ALTER TABLE history ADD COLUMN user_id VARCHAR(36) NULL;
```

### Step 2: Add Indexes
```sql
CREATE INDEX idx_tasks_user_id ON tasks(user_id);
CREATE INDEX idx_history_user_id ON history(user_id);
CREATE INDEX idx_history_user_timestamp ON history(user_id, timestamp);
```

### Step 3: Add Foreign Keys
```sql
ALTER TABLE tasks
  ADD CONSTRAINT fk_tasks_user_id
  FOREIGN KEY (user_id) REFERENCES users(id)
  ON DELETE CASCADE;

ALTER TABLE history
  ADD CONSTRAINT fk_history_user_id
  FOREIGN KEY (user_id) REFERENCES users(id)
  ON DELETE CASCADE;
```

### Step 4: Application Logic Update
- Update all service methods to filter by user_id
- Add user_id assignment in create operations
- Update tests to include user_id

### Rollback Strategy
```sql
ALTER TABLE tasks DROP CONSTRAINT fk_tasks_user_id;
ALTER TABLE history DROP CONSTRAINT fk_history_user_id;
DROP INDEX idx_tasks_user_id;
DROP INDEX idx_history_user_id;
DROP INDEX idx_history_user_timestamp;
ALTER TABLE tasks DROP COLUMN user_id;
ALTER TABLE history DROP COLUMN user_id;
```

---

## Security Considerations

1. **Password Security**:
   - Never store plaintext passwords
   - BetterAuth handles hashing (bcrypt/argon2)
   - Password hashes never exposed in API responses

2. **User Isolation**:
   - All queries MUST filter by authenticated user_id
   - Foreign key constraints prevent orphaned records
   - 403 Forbidden if user tries to access another user's data

3. **Session Security**:
   - JWT tokens stored in httpOnly cookies (XSS protection)
   - Secure flag enforced in production (HTTPS only)
   - SameSite=Lax for CSRF protection
   - 30-day expiry enforced

4. **Audit Trail**:
   - History entries are immutable
   - User actions tracked with user_id
   - Timestamps for all actions

---

## Next Steps

Phase 1 data model complete. Proceed to:
- Generate API contracts in `/contracts/` directory
- Generate quickstart.md for developer setup
- Update agent context with new models
