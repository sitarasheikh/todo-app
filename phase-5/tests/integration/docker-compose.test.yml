version: '3.8'

# Docker Compose Test Environment for Integration Tests
# Provides Kafka, PostgreSQL, and Dapr for event flow testing

services:
  # PostgreSQL database
  postgres:
    image: postgres:16-alpine
    container_name: test-postgres
    environment:
      POSTGRES_USER: testuser
      POSTGRES_PASSWORD: testpass
      POSTGRES_DB: testdb
    ports:
      - "5433:5432"  # Use different port to avoid conflicts
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U testuser"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Kafka (using Bitnami image for easy setup)
  kafka:
    image: bitnami/kafka:3.6.0
    container_name: test-kafka
    ports:
      - "9093:9092"  # Use different port to avoid conflicts
    environment:
      # KRaft mode (no Zookeeper)
      KAFKA_CFG_NODE_ID: 1
      KAFKA_CFG_PROCESS_ROLES: broker,controller
      KAFKA_CFG_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_CFG_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093
      KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT
      KAFKA_CFG_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9093
      KAFKA_CFG_CONTROLLER_QUORUM_VOTERS: 1@kafka:9093
      KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE: true
      KAFKA_CFG_LOG_RETENTION_HOURS: 1
      ALLOW_PLAINTEXT_LISTENER: yes
    healthcheck:
      test: ["CMD-SHELL", "kafka-topics.sh --bootstrap-server localhost:9092 --list"]
      interval: 10s
      timeout: 10s
      retries: 5

  # Dapr placement service
  dapr-placement:
    image: daprio/dapr:1.15.0
    container_name: test-dapr-placement
    command: ["./placement", "-port", "50006"]
    ports:
      - "50006:50006"
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:50006/healthz"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Dapr scheduler service (for Jobs API)
  dapr-scheduler:
    image: daprio/dapr:1.15.0
    container_name: test-dapr-scheduler
    command: ["./scheduler", "-port", "50007"]
    ports:
      - "50007:50007"
    depends_on:
      dapr-placement:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:50007/healthz"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Test backend service (optional - can run locally)
  # Uncomment to run backend in Docker for integration tests
  # backend:
  #   build:
  #     context: ../../backend
  #     dockerfile: Dockerfile
  #   container_name: test-backend
  #   ports:
  #     - "8001:8000"
  #   environment:
  #     DATABASE_URL: postgresql://testuser:testpass@postgres:5432/testdb
  #     KAFKA_BOOTSTRAP_SERVERS: kafka:9092
  #     DAPR_HTTP_PORT: 3500
  #     DAPR_GRPC_PORT: 50001
  #   depends_on:
  #     postgres:
  #       condition: service_healthy
  #     kafka:
  #       condition: service_healthy
  #     dapr-placement:
  #       condition: service_healthy
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5

networks:
  default:
    name: test-network
