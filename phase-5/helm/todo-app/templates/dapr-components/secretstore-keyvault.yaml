# Dapr Secret Store Component - Azure Key Vault (Production)
# Phase V: Enterprise-Grade Cloud Infrastructure
# Task: T048 - Update Dapr secretstore component to use Azure Key Vault in production

apiVersion: dapr.io/v1alpha1
kind: Component
metadata:
  name: secretstore
  namespace: {{ .Values.namespace }}
spec:
  type: secretstores.azure.keyvault
  version: v1
  metadata:
    # Azure Key Vault URL (from Terraform output)
    - name: vaultName
      value: "{{ .Values.dapr.secretstore.keyvault.vaultName }}"

    # Authentication method: Using AKS Managed Identity (recommended)
    # The AKS kubelet identity is granted access to Key Vault via Terraform
    - name: azureEnvironment
      value: "AZUREPUBLICCLOUD"

    # Optional: Specific Azure tenant ID
    {{- if .Values.dapr.secretstore.keyvault.tenantId }}
    - name: azureTenantId
      value: "{{ .Values.dapr.secretstore.keyvault.tenantId }}"
    {{- end }}

    # Optional: Specific Azure client ID (if using user-assigned managed identity)
    {{- if .Values.dapr.secretstore.keyvault.clientId }}
    - name: azureClientId
      value: "{{ .Values.dapr.secretstore.keyvault.clientId }}"
    {{- end }}

  # Scoped to specific applications for security
  scopes:
    - backend
    - recurring-task-service
    - notification-service
---
# Alternative: Kubernetes Secret Store (for local/staging)
# Uncomment this section for non-production environments
{{- if eq .Values.environment "development" }}
apiVersion: dapr.io/v1alpha1
kind: Component
metadata:
  name: secretstore-local
  namespace: {{ .Values.namespace }}
spec:
  type: secretstores.kubernetes
  version: v1
  metadata:
    # No additional metadata needed for Kubernetes secret store
    - name: defaultNamespace
      value: {{ .Values.namespace }}
  scopes:
    - backend
    - recurring-task-service
    - notification-service
{{- end }}
