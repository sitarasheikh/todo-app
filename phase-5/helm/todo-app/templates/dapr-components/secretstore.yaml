# Dapr Secret Store Component
# Local: Kubernetes Secrets | Production: Azure Key Vault
apiVersion: dapr.io/v1alpha1
kind: Component
metadata:
  name: secretstore
  namespace: {{ .Release.Namespace }}
  labels:
    app: {{ .Chart.Name }}
    chart: {{ .Chart.Name }}-{{ .Chart.Version }}
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
spec:
  {{- if or (eq .Values.environment "local") (eq .Values.environment "development") }}
  # Local/Development: Kubernetes Secret Store
  type: secretstores.kubernetes
  version: v1
  metadata:
  # Use current namespace for secrets
  - name: namespace
    value: {{ .Release.Namespace | quote }}

  # Optional: Restrict to specific secret names (comma-separated)
  {{- if .Values.secrets.allowedSecrets }}
  - name: allowedSecrets
    value: {{ .Values.secrets.allowedSecrets | join "," | quote }}
  {{- end }}

  {{- else if eq .Values.environment "production" }}
  # Production: Azure Key Vault with Managed Identity
  type: secretstores.azure.keyvault
  version: v1
  metadata:
  # Azure Key Vault name
  - name: vaultName
    value: {{ .Values.azure.keyVault.name | required "azure.keyVault.name is required for production" | quote }}

  # Managed Identity authentication (no client secret)
  # Azure Managed Identity must be enabled on AKS cluster
  - name: azureEnvironment
    value: {{ .Values.azure.environment | default "AZUREPUBLICCLOUD" | quote }}

  # Optional: User-assigned managed identity client ID
  {{- if .Values.azure.managedIdentity.clientId }}
  - name: azureClientId
    value: {{ .Values.azure.managedIdentity.clientId | quote }}
  {{- end }}

  # Cache TTL for secrets (reduces Key Vault API calls)
  - name: cacheTTL
    value: {{ .Values.azure.keyVault.cacheTTL | default "60s" | quote }}

  {{- else if eq .Values.environment "staging" }}
  # Staging: Can use either Kubernetes or Azure Key Vault
  {{- if .Values.azure.keyVault.enabled }}
  # Staging with Azure Key Vault
  type: secretstores.azure.keyvault
  version: v1
  metadata:
  - name: vaultName
    value: {{ .Values.azure.keyVault.name | quote }}

  - name: azureEnvironment
    value: {{ .Values.azure.environment | default "AZUREPUBLICCLOUD" | quote }}

  {{- if .Values.azure.managedIdentity.clientId }}
  - name: azureClientId
    value: {{ .Values.azure.managedIdentity.clientId | quote }}
  {{- end }}

  - name: cacheTTL
    value: {{ .Values.azure.keyVault.cacheTTL | default "60s" | quote }}
  {{- else }}
  # Staging with Kubernetes Secrets (fallback)
  type: secretstores.kubernetes
  version: v1
  metadata:
  - name: namespace
    value: {{ .Release.Namespace | quote }}
  {{- end }}
  {{- end }}
---
# Secret Access Pattern
# Secrets are accessed via Dapr API:
#   GET http://localhost:3500/v1.0/secrets/{store-name}/{key-name}
#
# Expected secrets for todo-app:
#   - database-url: PostgreSQL connection string
#   - openai-api-key: OpenAI API key for LLM
#   - groq-api-key: Groq API key (alternative LLM)
#   - better-auth-secret: Better Auth JWT secret
#   - kafka-username: Kafka SASL username (production only)
#   - kafka-password: Kafka SASL password (production only)
#
# Kubernetes Secret creation example (local/staging):
#   kubectl create secret generic todo-secrets \
#     --from-literal=database-url=postgresql://... \
#     --from-literal=openai-api-key=sk-... \
#     --namespace=todo-app
#
# Azure Key Vault secret naming:
#   - Use hyphens instead of underscores (database-url not database_url)
#   - Dapr automatically converts underscores to hyphens
